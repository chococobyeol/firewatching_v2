/**
 * Fire Controls - Î∂à Ìö®Í≥º ÌååÎùºÎØ∏ÌÑ∞ Ï°∞Ï†ïÏùÑ ÏúÑÌïú Ïª®Ìä∏Î°§ Ìå®ÎÑê
 */

class FireControls {
    constructor() {
        this.fire = null;
        this.rotationSpeed = 0;
        this.defaultValues = {
            scale: 2,
            rotationSpeed: 0,
            magnitude: 1.3,
            lacunarity: 2.0,
            gain: 0.5,
            baseWidth: 0.5,
            noiseScaleX: 1,
            noiseScaleY: 2,
            noiseScaleZ: 1,
            noiseScaleW: 0.75,
            colorR: 238,
            colorG: 238,
            colorB: 238
        };
        
        this.controlsData = [
            {
                groupName: 'Í∏∞Î≥∏ ÏÑ§Ï†ï',
                controls: [
                    { id: 'scale', label: 'ÌÅ¨Í∏∞ (Scale)', min: 0.5, max: 5, step: 0.1, value: 2 },
                    { id: 'rotation-speed', label: 'ÌöåÏ†Ñ ÏÜçÎèÑ', min: 0, max: 2, step: 0.1, value: 0 }
                ]
            },
            {
                groupName: 'Î∂à Î™®Ïñë Ï°∞Ï†ï',
                controls: [
                    { id: 'magnitude', label: 'Magnitude', min: 0.1, max: 3, step: 0.1, value: 1.3 },
                    { id: 'lacunarity', label: 'Lacunarity', min: 1, max: 4, step: 0.1, value: 2.0 },
                    { id: 'gain', label: 'Gain', min: 0.1, max: 1, step: 0.05, value: 0.5 },
                    { id: 'base-width', label: 'ÏïÑÎûòÏ™Ω ÎÑàÎπÑ', min: 0.1, max: 1, step: 0.05, value: 0.5 }
                ]
            },
            {
                groupName: 'ÎÖ∏Ïù¥Ï¶à Ïä§ÏºÄÏùº',
                controls: [
                    { id: 'noise-scale-x', label: 'X Ïä§ÏºÄÏùº', min: 0.1, max: 3, step: 0.1, value: 1 },
                    { id: 'noise-scale-y', label: 'Y Ïä§ÏºÄÏùº', min: 0.1, max: 5, step: 0.1, value: 2 },
                    { id: 'noise-scale-z', label: 'Z Ïä§ÏºÄÏùº', min: 0.1, max: 3, step: 0.1, value: 1 },
                    { id: 'noise-scale-w', label: 'ÏÜçÎèÑ (Speed)', min: 0.1, max: 1, step: 0.05, value: 0.75 }
                ]
            },
            {
                groupName: 'ÏÉâÏÉÅ',
                controls: [
                    { id: 'color-r', label: 'Îπ®Í∞ï', min: 0, max: 255, step: 1, value: 238 },
                    { id: 'color-g', label: 'Ï¥àÎ°ù', min: 0, max: 255, step: 1, value: 238 },
                    { id: 'color-b', label: 'ÌååÎûë', min: 0, max: 255, step: 1, value: 238 }
                ]
            }
        ];
        
        this.init();
    }

    init() {
        this.createUI();
        this.setupEventListeners();
    }

    createUI() {
        // ÌÜ†Í∏Ä Î≤ÑÌäº ÏÉùÏÑ±
        this.createToggleButton();
        
        // Ïª®Ìä∏Î°§ Ìå®ÎÑê ÏÉùÏÑ±
        this.createControlPanel();
    }

    createToggleButton() {
        const toggleButton = document.createElement('button');
        toggleButton.id = 'toggle-controls';
        toggleButton.textContent = 'Ïª®Ìä∏Î°§ Ïà®Í∏∞Í∏∞/Î≥¥Ïù¥Í∏∞';
        document.body.appendChild(toggleButton);
    }

    createControlPanel() {
        // Î©îÏù∏ Ïª®Ìä∏Î°§ Ìå®ÎÑê Ïª®ÌÖåÏù¥ÎÑà
        const controlsDiv = document.createElement('div');
        controlsDiv.id = 'controls';
        
        // Ï†úÎ™© Ï∂îÍ∞Ä
        const title = document.createElement('h2');
        title.textContent = 'üî• Fire Controls';
        title.style.marginTop = '0';
        title.style.color = '#ff6600';
        controlsDiv.appendChild(title);
        
        // Í∞Å Ïª®Ìä∏Î°§ Í∑∏Î£π ÏÉùÏÑ±
        this.controlsData.forEach(group => {
            const groupDiv = this.createControlGroup(group);
            controlsDiv.appendChild(groupDiv);
        });
        
        // Î¶¨ÏÖã Î≤ÑÌäº Í∑∏Î£π Ï∂îÍ∞Ä
        const resetGroup = this.createResetButtonGroup();
        controlsDiv.appendChild(resetGroup);
        
        document.body.appendChild(controlsDiv);
    }

    createControlGroup(groupData) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'control-group';
        
        // Í∑∏Î£π Ï†úÎ™©
        const groupTitle = document.createElement('h3');
        groupTitle.textContent = groupData.groupName;
        groupDiv.appendChild(groupTitle);
        
        // Í∞Å Ïª®Ìä∏Î°§ ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
        groupData.controls.forEach(control => {
            const controlItem = this.createControlItem(control);
            groupDiv.appendChild(controlItem);
        });
        
        return groupDiv;
    }

    createControlItem(controlData) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'control-item';
        
        // ÎùºÎ≤®
        const label = document.createElement('label');
        label.textContent = controlData.label + ':';
        itemDiv.appendChild(label);
        
        // Ïä¨ÎùºÏù¥Îçî
        const slider = document.createElement('input');
        slider.type = 'range';
        slider.id = controlData.id;
        slider.min = controlData.min;
        slider.max = controlData.max;
        slider.step = controlData.step;
        slider.value = controlData.value;
        itemDiv.appendChild(slider);
        
        // Í∞í ÌëúÏãú Ïä§Ìå¨
        const valueSpan = document.createElement('span');
        valueSpan.id = controlData.id + '-value';
        valueSpan.textContent = controlData.value.toFixed(2);
        itemDiv.appendChild(valueSpan);
        
        return itemDiv;
    }

    createResetButtonGroup() {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'control-group';
        
        const resetButton = document.createElement('button');
        resetButton.id = 'reset-button';
        resetButton.className = 'reset-button';
        resetButton.textContent = 'Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã';
        
        groupDiv.appendChild(resetButton);
        return groupDiv;
    }

    setupEventListeners() {
        // DOMÏù¥ ÏôÑÏ†ÑÌûà ÏÉùÏÑ±Îêú ÌõÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        setTimeout(() => {
            this.setupToggleButton();
            this.setupResetButton();
        }, 0);
    }

    setFire(fire) {
        this.fire = fire;
        this.setupControls();
        this.applyDefaultValues();
    }

    setupToggleButton() {
        const toggleButton = document.getElementById('toggle-controls');
        const controls = document.getElementById('controls');
        
        if (toggleButton && controls) {
            toggleButton.addEventListener('click', () => {
                controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
            });
        }
    }

    setupResetButton() {
        const resetButton = document.getElementById('reset-button');
        if (resetButton) {
            resetButton.addEventListener('click', () => {
                this.resetToDefaults();
            });
        }
    }

    setupControls() {
        if (!this.fire) return;

        // Í∏∞Î≥∏ ÏÑ§Ï†ï Ïª®Ìä∏Î°§
        this.setupSlider('scale', (value) => {
            this.fire.scale.set(value, value, value);
        });

        this.setupSlider('rotation-speed', (value) => {
            this.rotationSpeed = value;
        });

        // Î∂à Î™®Ïñë Ï°∞Ï†ï Ïª®Ìä∏Î°§
        this.setupSlider('magnitude', (value) => {
            this.fire.material.uniforms.magnitude.value = value;
        });

        this.setupSlider('lacunarity', (value) => {
            this.fire.material.uniforms.lacunarity.value = value;
        });

        this.setupSlider('gain', (value) => {
            this.fire.material.uniforms.gain.value = value;
        });

        this.setupSlider('base-width', (value) => {
            this.fire.material.uniforms.baseWidth.value = value;
        });

        // ÎÖ∏Ïù¥Ï¶à Ïä§ÏºÄÏùº Ïª®Ìä∏Î°§
        this.setupSlider('noise-scale-x', (value) => {
            this.fire.material.uniforms.noiseScale.value.x = value;
        });

        this.setupSlider('noise-scale-y', (value) => {
            this.fire.material.uniforms.noiseScale.value.y = value;
        });

        this.setupSlider('noise-scale-z', (value) => {
            this.fire.material.uniforms.noiseScale.value.z = value;
        });

        this.setupSlider('noise-scale-w', (value) => {
            this.fire.material.uniforms.noiseScale.value.w = value;
        });

        // ÏÉâÏÉÅ Ïª®Ìä∏Î°§
        const updateColor = () => {
            const r = document.getElementById('color-r').value / 255;
            const g = document.getElementById('color-g').value / 255;
            const b = document.getElementById('color-b').value / 255;
            this.fire.material.uniforms.color.value.setRGB(r, g, b);
        };

        this.setupSlider('color-r', updateColor);
        this.setupSlider('color-g', updateColor);
        this.setupSlider('color-b', updateColor);
    }

    setupSlider(id, callback) {
        const slider = document.getElementById(id);
        const valueSpan = document.getElementById(id + '-value');
        
        if (!slider || !valueSpan) {
            console.warn(`Slider or value span not found for id: ${id}`);
            return;
        }
        
        slider.addEventListener('input', () => {
            const value = parseFloat(slider.value);
            valueSpan.textContent = value.toFixed(2);
            callback(value);
        });
    }

    applyDefaultValues() {
        if (!this.fire) return;

        // Fire Í∞ùÏ≤¥Ïóê Í∏∞Î≥∏Í∞í Ï†ÅÏö©
        this.fire.scale.set(
            this.defaultValues.scale, 
            this.defaultValues.scale, 
            this.defaultValues.scale
        );
        
        this.rotationSpeed = this.defaultValues.rotationSpeed;
        
        this.fire.material.uniforms.magnitude.value = this.defaultValues.magnitude;
        this.fire.material.uniforms.lacunarity.value = this.defaultValues.lacunarity;
        this.fire.material.uniforms.gain.value = this.defaultValues.gain;
        this.fire.material.uniforms.baseWidth.value = this.defaultValues.baseWidth;
        
        this.fire.material.uniforms.noiseScale.value.set(
            this.defaultValues.noiseScaleX,
            this.defaultValues.noiseScaleY,
            this.defaultValues.noiseScaleZ,
            this.defaultValues.noiseScaleW
        );
        
        this.fire.material.uniforms.color.value.setRGB(
            this.defaultValues.colorR / 255,
            this.defaultValues.colorG / 255,
            this.defaultValues.colorB / 255
        );

        // UI ÏóÖÎç∞Ïù¥Ìä∏
        this.updateAllDisplayValues();
    }

    resetToDefaults() {
        if (!this.fire) return;

        // Ïä¨ÎùºÏù¥Îçî Í∞íÎì§ÏùÑ Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã
        document.getElementById('scale').value = this.defaultValues.scale;
        document.getElementById('rotation-speed').value = this.defaultValues.rotationSpeed;
        document.getElementById('magnitude').value = this.defaultValues.magnitude;
        document.getElementById('lacunarity').value = this.defaultValues.lacunarity;
        document.getElementById('gain').value = this.defaultValues.gain;
        document.getElementById('base-width').value = this.defaultValues.baseWidth;
        document.getElementById('noise-scale-x').value = this.defaultValues.noiseScaleX;
        document.getElementById('noise-scale-y').value = this.defaultValues.noiseScaleY;
        document.getElementById('noise-scale-z').value = this.defaultValues.noiseScaleZ;
        document.getElementById('noise-scale-w').value = this.defaultValues.noiseScaleW;
        document.getElementById('color-r').value = this.defaultValues.colorR;
        document.getElementById('color-g').value = this.defaultValues.colorG;
        document.getElementById('color-b').value = this.defaultValues.colorB;

        // Ïã§Ï†ú Í∞íÎì§ Ï†ÅÏö©
        this.applyDefaultValues();
    }

    updateAllDisplayValues() {
        const sliders = [
            'scale', 'rotation-speed', 'magnitude', 'lacunarity', 'gain', 'base-width',
            'noise-scale-x', 'noise-scale-y', 'noise-scale-z', 'noise-scale-w',
            'color-r', 'color-g', 'color-b'
        ];
        
        sliders.forEach(id => {
            const slider = document.getElementById(id);
            const valueSpan = document.getElementById(id + '-value');
            if (slider && valueSpan) {
                valueSpan.textContent = parseFloat(slider.value).toFixed(2);
            }
        });
    }

    getRotationSpeed() {
        return this.rotationSpeed;
    }

    // ÏÉàÎ°úÏö¥ Ïª®Ìä∏Î°§ÏùÑ ÏâΩÍ≤å Ï∂îÍ∞ÄÌï† Ïàò ÏûàÎäî Î©îÏÑúÎìú
    addControl(groupIndex, controlData) {
        this.controlsData[groupIndex].controls.push(controlData);
        // UI Ïû¨ÏÉùÏÑ±Ïù¥ ÌïÑÏöîÌïú Í≤ΩÏö∞ Ïó¨Í∏∞ÏÑú Ï≤òÎ¶¨
    }

    // Ïª®Ìä∏Î°§ Ìå®ÎÑê Ïà®Í∏∞Í∏∞/Î≥¥Ïù¥Í∏∞
    toggleControls() {
        const controls = document.getElementById('controls');
        if (controls) {
            controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
        }
    }
}

// Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú FireControls Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
window.fireControls = new FireControls(); 